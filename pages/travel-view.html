<!DOCTYPE html>
<html lang="en" class="travel-view-page">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
  <link rel="stylesheet" href="/css/travel-view.css" />
  <link rel="stylesheet" href="/css/travel-view-details.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/footer.css" />
  <link rel="stylesheet" href="/css/navbar.css" />
  <title>Travel View</title>
</head>
<body>
  <!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

  <div class="travel-view container">
    <div class="travel-content">
      <img src="" alt="" class="travel-image" id="travel-image">
      <div class="travel-info">
        <p><strong id="travel-title"></strong></p>
        <p class="location-info">
          <box-icon name="map" type="solid" color="#4CAF50"></box-icon> <span id="travel-location"></span>
        </p>
        <br>
        <p><strong>Description</strong></p>
        <p id="travel-description"></p>
      </div>
      
      <!-- Trip Details will be inserted here by JavaScript -->
      <div class="trip-details" id="trip-details"></div>
      
      <!-- Gallery will be inserted here by JavaScript -->
      <div class="gallery" id="gallery">
        <div class="gallery-images" id="gallery-images"></div>
        <div class="slider-controls">
          <button class="prev-btn">&#10094;</button>
          <button class="next-btn">&#10095;</button>
        </div>
      </div>
      
      <!-- Reviews Section -->
      <div class="travel-reviews" id="travel-reviews">
        <p><strong>Reviews (<span id="review-count">0</span>)</strong></p>
        <div class="review-form">
          <div class="form-group">
            <input type="text" placeholder="Your Name" id="review-guest-name">
          </div>
          <textarea placeholder="Share your feedback..." id="review-comment"></textarea>
          <div class="rating-row">
            <div class="rating-section">
              <label>Rate this tour:</label>
              <span class="rating-stars" id="rating-stars">☆☆☆☆☆</span>
            </div>
            <button class="book-btn submit-review">Publish</button>
          </div>
        </div>
        <div id="reviews-list" class="reviews-list-container">
          <!-- Reviews will be dynamically added here -->
        </div>
      </div>
    </div>
    
    <div class="travel-booking">
      <h3>Tour Information</h3>
      <div class="form-group">
        <label>Tour Destination</label>
        <input type="text" placeholder="Tour Destination" disabled id="booking-location">
      </div>
      <div class="form-group">
        <label>Guest Name</label>
        <input type="text" placeholder="Guest Full Name" id="booking-guest-name">
      </div>
      <div class="form-group">
        <label>Mobile Number</label>
        <input type="text" placeholder="Mobile Number" id="booking-whatsapp-number">
      </div>
      <div class="form-group date-input">
        <label>Tour Date</label>
        <div class="date-input-wrapper">
          <input type="date" id="booking-date" name="booking-date">
          <i class="ri-calendar-line calendar-icon"></i>
        </div>
      </div>
      <div class="form-group">
        <label>Guest Group Size (Max 7 Person)</label>
        <input type="number" placeholder="Guest Group Size" value="1" min="1" id="booking-group-size">
      </div>
      <div class="price total">Total <span id="total-price"></span></div>
      <button class="book-btn" id="whatsapp-book-btn"><box-icon name="whatsapp" type="logo" color="#fff"></box-icon> Book via WhatsApp</button>
    </div>
  </div>

  <!-- Footer Placeholder -->
  <div id="footer-placeholder"></div>

  <script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error(e);
          return "";
        }
      }
      return gk_fileData[filename] || "";
    }
  </script>

  <!-- IMPORTANT: Load featuredPosts.js FIRST to access the data -->
  <script src="/js/featuredPosts.js"></script>

  <script>
    // Function to load navbar and footer
    function loadComponent(id, file) {
      fetch(file)
        .then(response => {
          if (!response.ok) throw new Error(`Failed to fetch ${file}: ${response.statusText}`);
          return response.text();
        })
        .then(data => {
          document.getElementById(id).innerHTML = data;
          console.log(`Component ${id} loaded from ${file}`);
          if (id === 'navbar-placeholder') {
            const menuBtn = document.getElementById("menu-btn");
            const navLinks = document.getElementById("nav-links");
            const menuBtnIcon = menuBtn.querySelector("i");
            menuBtn.addEventListener("click", () => {
              navLinks.classList.toggle("open");
              const isOpen = navLinks.classList.contains("open");
              menuBtnIcon.setAttribute("class", isOpen ? "ri-close-line" : "ri-menu-line");
            });
            navLinks.addEventListener("click", () => {
              navLinks.classList.remove("open");
              menuBtnIcon.setAttribute("class", "ri-menu-line");
            });
          }
        })
        .catch(error => console.error('Error loading component:', error));
    }

    // Load navbar and footer
    loadComponent('navbar-placeholder', '/components/navbar.html');
    loadComponent('footer-placeholder', '/components/footer.html');

    // Function to get today's date in Sri Lanka timezone
    function getTodayInSriLanka() {
      const now = new Date();
      const offsetMs = 5.5 * 60 * 60 * 1000;
      const sriLankaTime = new Date(now.getTime() + offsetMs);
      const year = sriLankaTime.getUTCFullYear();
      const month = String(sriLankaTime.getUTCMonth() + 1).padStart(2, '0');
      const day = String(sriLankaTime.getUTCDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Function to show toast notification
    function showToast(message, type = 'error') {
      const toast = document.createElement('div');
      toast.className = `toast-notification ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Function to send WhatsApp message
    function sendWhatsAppMessage() {
      const title = document.getElementById('travel-title').textContent;
      const location = document.getElementById('travel-location').textContent;
      const guestName = document.getElementById('booking-guest-name').value;
      const whatsappNumber = document.getElementById('booking-whatsapp-number').value;
      const bookingDate = document.getElementById('booking-date').value;
      const groupSize = document.getElementById('booking-group-size').value;
      const totalPrice = document.getElementById('total-price').textContent;

      if (!guestName) {
        showToast('Please enter your name.', 'error');
        return;
      } 
      if (!whatsappNumber) {
        showToast('Please enter your Mobile number.', 'error');
        return;
      }
      if (!bookingDate) {
        showToast('Please select a tour date.', 'error');
        return;
      }

      const message = `Booking Request:\n\nTour: ${title}\nLocation: ${location}\nGuest Name: ${guestName}\nWhatsApp Number: ${whatsappNumber}\nDate: ${bookingDate}\nGroup Size: ${groupSize}\nTotal Price: ${totalPrice}\n\nPlease confirm my booking.`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappURL = `https://wa.me/94773467723?text=${encodedMessage}`;
      window.open(whatsappURL, '_blank');
      showToast('Booking request sent successfully!', 'toast-success');
    }

    // Enhanced Function to initialize mobile slider
    function initializeSlider() {
      const galleryContainer = document.getElementById('gallery-images');
      const images = document.querySelectorAll('.gallery-img');
      const prevBtn = document.querySelector('.prev-btn');
      const nextBtn = document.querySelector('.next-btn');
      let currentIndex = 0;
      let autoPlayInterval;
      let touchStartX = 0;
      let touchEndX = 0;

      if (images.length === 0) return;

      function showImage(index) {
        images.forEach((img, i) => {
          if (i === index) {
            img.classList.add('active');
            img.style.display = 'block';
          } else {
            img.classList.remove('active');
            img.style.display = 'none';
          }
        });
        updateButtons();
      }

      function updateButtons() {
        if (currentIndex === 0) {
          prevBtn.disabled = true;
        } else {
          prevBtn.disabled = false;
        }

        if (currentIndex === images.length - 1) {
          nextBtn.disabled = true;
        } else {
          nextBtn.disabled = false;
        }
      }

      function goToNext() {
        if (currentIndex < images.length - 1) {
          currentIndex++;
          showImage(currentIndex);
        }
      }

      function goToPrev() {
        if (currentIndex > 0) {
          currentIndex--;
          showImage(currentIndex);
        }
      }

      function startAutoPlay() {
        stopAutoPlay();
        autoPlayInterval = setInterval(() => {
          if (currentIndex < images.length - 1) {
            goToNext();
          } else {
            currentIndex = 0;
            showImage(currentIndex);
          }
        }, 3000);
      }

      function stopAutoPlay() {
        if (autoPlayInterval) {
          clearInterval(autoPlayInterval);
        }
      }

      function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
        stopAutoPlay();
      }

      function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
        startAutoPlay();
      }

      function handleSwipe() {
        const swipeThreshold = 50;
        const difference = touchStartX - touchEndX;

        if (Math.abs(difference) > swipeThreshold) {
          if (difference > 0) {
            goToNext();
          } else {
            goToPrev();
          }
        }
      }

      showImage(currentIndex);
      startAutoPlay();

      prevBtn.addEventListener('click', () => {
        goToPrev();
        stopAutoPlay();
        startAutoPlay();
      });

      nextBtn.addEventListener('click', () => {
        goToNext();
        stopAutoPlay();
        startAutoPlay();
      });

      galleryContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
      galleryContainer.addEventListener('touchend', handleTouchEnd, { passive: true });

      galleryContainer.addEventListener('mouseenter', stopAutoPlay);
      galleryContainer.addEventListener('mouseleave', startAutoPlay);

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          stopAutoPlay();
        } else if (window.innerWidth <= 524) {
          startAutoPlay();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      let postsData = [];
      
      if (typeof getToursData === 'function') {
        postsData = getToursData();
        console.log('Tours data loaded from featuredPosts.js:', postsData.length, 'tours');
      } else {
        console.error('getToursData function not found! Make sure featuredPosts.js is loaded.');
        showToast('Error loading tour data. Please refresh the page.', 'error');
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const title = decodeURIComponent(urlParams.get('title'));
      
      console.log('Looking for tour with title:', title);
      const post = postsData.find(p => p.title === title);
      
      if (post) {
        document.getElementById('travel-image').src = post.img;
        document.getElementById('travel-image').alt = post.title;
        document.getElementById('travel-title').textContent = post.title;
        document.getElementById('travel-location').textContent = post.location;
        document.getElementById('travel-description').textContent = post.description || 'No description available.';
        document.getElementById('booking-location').value = post.title;
        document.getElementById('total-price').textContent = '$' + post.price;
        console.log('Post loaded successfully:', post.title);

        // Populate Trip Details Cards
        const tripDetailsContainer = document.getElementById('trip-details');
        if (post.details && post.details.length > 0) {
          post.details.slice(0, 3).forEach(detail => {
            const card = document.createElement('div');
            card.className = 'detail-card';
            card.innerHTML = `
              <h4 class="detail-title">${detail.title}</h4>
              <ul class="detail-points">
                ${detail.points.map(point => `<li>${point}</li>`).join('')}
              </ul>
            `;
            tripDetailsContainer.appendChild(card);
          });
        } else {
          tripDetailsContainer.style.display = 'none';
        }

        // Populate Gallery Images
        const galleryImagesContainer = document.getElementById('gallery-images');
        if (post.gallery && post.gallery.length > 0) {
          post.gallery.forEach((imgSrc, index) => {
            const img = document.createElement('img');
            img.src = imgSrc;
            img.alt = `${post.title} Gallery Image ${index + 1}`;
            img.className = 'gallery-img';
            galleryImagesContainer.appendChild(img);
          });

          // Initialize Mobile Slider
          if (window.innerWidth <= 524) {
            initializeSlider();
          }
          window.addEventListener('resize', () => {
            if (window.innerWidth <= 524) {
              initializeSlider();
            }
          });
        } else {
          document.getElementById('gallery').style.display = 'none';
        }
      } else {
        console.error('Post not found for title:', title);
        showToast('Tour not found. Redirecting to homepage...', 'error');
        setTimeout(() => {
          window.location.href = '/index.html';
        }, 3000);
      }

      const today = getTodayInSriLanka();
      document.getElementById('booking-date').value = today;
      document.getElementById('booking-date').setAttribute('min', today);

      console.log('Calling initializeReviews...');
      if (typeof initializeReviews === 'function') {
        initializeReviews();
      } else {
        console.error('initializeReviews function not found!');
      }

      document.getElementById('whatsapp-book-btn').addEventListener('click', sendWhatsAppMessage);
    });
  </script>

  <!-- Load EmailJS library -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <!-- Load review scripts AFTER EmailJS -->
  <script src="/js/reviewsData.js"></script>
  <script src="/js/reviews.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="/js/navbar-autohide.js"></script>
</body>
</html>